#!/usr/bin/env bash
guest_kernel=kernel
guest_initrd=initrd
poweroff_cmd="sudo systemctl poweroff"

function install() {
    port=$1
    shift 1
    guest_ssh -p $port build@localhost EDITOR=true pacaur --noconfirm --noedit -Syu "$@"
}

function sanity_check() {
    boot 8022 &
    qemu=$!
    sleep 5
    # This script is set -e so any failure will cause the sanity check to exit non-zero
    # Does sudo work?
    guest_ssh -p 8022 build@localhost sudo ls -a
    # Does pacman work?
    guest_ssh -p 8022 build@localhost sudo pacman -Syu
    # Does networking work?
    guest_ssh -p 8022 build@localhost curl http://example.org
    # Does git work?
    guest_ssh -p 8022 build@localhost git --version
    # Does pacaur work?
    install 8022 brightnessctl
    # Shut down
    guest_ssh -p 8022 build@localhost sudo systemctl poweroff || true
    wait $qemu
    cleanup 8022
}
