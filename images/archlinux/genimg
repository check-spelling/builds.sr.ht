#!/bin/sh -ex
root=root

cleaned_up=0
cleanup() {
	[ "$cleaned_up" -eq 1 ] && return
	cleaned_up=1
	# The order here is important if you don't want to hose your mounts
	umount -Rf "$root" || true
	qemu-nbd --disconnect /dev/nbd0 || true
	rm -rf "$root" || true
}

qemu-img create -f qcow2 root.img.qcow2 16G
modprobe nbd
qemu-nbd --connect=/dev/nbd0 root.img.qcow2
trap cleanup EXIT

mkdir -p "$root"
mkfs.ext4 /dev/nbd0
mount /dev/nbd0 "$root"

pacstrap root base base-devel git openssh

function run_root() {
    local cmd="$@"
    chroot $root /bin/bash -c "$cmd"
}

function run_normal() {
    local cmd="$@"
    chroot --userspec=$SUDO_UID:$SUDO_GID \
        $root \
        /bin/bash -c "cd /home/build && $cmd"
}

echo 'Server = http://lug.mtu.edu/archlinux/$repo/os/$arch' >> $root/etc/pacman.d/mirrorlist
echo 'nameserver 8.8.8.8' >> $root/etc/resolv.conf

mount --bind /proc $root/proc
mount --bind /sys $root/sys
mount --bind /dev $root/dev
mount --bind /dev/pts $root/dev/pts
mount --bind /dev/shm $root/dev/shm
mount --bind /run $root/run

cp mkinitcpio.conf $root/etc

cat >$root/etc/pacman.d/mirrorlist <<EOF 
Server = http://mirror.rackspace.com/archlinux/\$repo/os/\$arch
Server = http://mirror.us.leaseweb.net/archlinux/\$repo/os/\$arch
Server = http://lug.mtu.edu/archlinux/\$repo/os/\$arch
Server = http://mirrors.kernel.org/archlinux/\$repo/os/\$arch
EOF

sed -i 's/#en_US.UTF-8/en_US.UTF-8/' $root/etc/locale.gen
run_root locale-gen

cat >"$root"/etc/systemd/network/25-ens3.network <<EOF
[Match]
Name=ens3

[Network]
Address=10.0.2.15/24
Gateway=10.0.2.2
EOF

run_root systemctl enable systemd-networkd.service
run_root systemctl enable systemd-timesyncd.service

run_root mkinitcpio -p linux

run_root groupadd sudo
run_root useradd -mG sudo,kvm build
run_root passwd -d build
echo '%sudo ALL=(ALL) NOPASSWD: ALL' >> $root/etc/sudoers
echo 'source /etc/profile.d/perlbin.sh' > $root/home/build/.bashrc
echo 'export EDITOR=true' > $root/home/build/.bashrc

sed -e 's/#PermitEmptyPasswords no/PermitEmptyPasswords yes/' -i $root/etc/ssh/sshd_config
run_root systemctl enable sshd

echo "makeopts=(--skippgpcheck)" >> $root/etc/makepkg.conf

run_normal curl -O https://aur.archlinux.org/cgit/aur.git/snapshot/yay.tar.gz
run_normal tar xf yay.tar.gz
run_normal 'cd yay && makepkg -si --noconfirm --skippgpcheck'
run_normal rm -r yay yay.tar.gz

pkill gpg-agent || true
cp $root/boot/vmlinuz-linux ./kernel
cp $root/boot/initramfs-linux.img ./initrd

run_root pacman --noconfirm -Rsc go

cleanup
