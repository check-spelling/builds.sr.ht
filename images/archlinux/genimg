#!/usr/bin/env bash
if [ $EUID != 0 ]
then
    echo "Must be run as root"
    exit 1
fi
set -xe

root=root.x86_64
bootstrap_date=$(date +'%Y.%m.01')
bootstrap=archlinux-bootstrap-$bootstrap_date-x86_64.tar.gz

if [ ! -f $bootstrap ]
then
    wget -c http://mirrors.kernel.org/archlinux/iso/$bootstrap_date/$bootstrap
fi
tar xf $bootstrap

function run_root() {
    local cmd="$@"
    chroot $root /bin/bash -c "$cmd"
}

function run_normal() {
    local cmd="$@"
    chroot --userspec=$SUDO_UID:$SUDO_GID \
        $root \
        /bin/bash -c "cd /home/build && $cmd"
}

echo 'Server = http://lug.mtu.edu/archlinux/$repo/os/$arch' >> $root/etc/pacman.d/mirrorlist
echo 'nameserver 8.8.8.8' >> $root/etc/resolv.conf

mount $root $root --bind
mount --bind /proc $root/proc
mount --bind /sys $root/sys
mount --bind /dev $root/dev
mount --bind /dev/pts $root/dev/pts
mount --bind /dev/shm $root/dev/shm
mount --bind /run $root/run

run_root pacman -Syy
run_root pacman-key --init
run_root pacman-key --populate archlinux
run_root pacman -Syu --force --noconfirm \
    base-devel \
    git \
    openssh \
    linux \
    mkinitcpio \
    systemd-sysvcompat \
    dhcpcd

sed -i 's/#en_US.UTF-8/en_US.UTF-8/' $root/etc/locale.gen
run_root locale-gen

cat <<EOF > $root/usr/lib/initcpio/hooks/fix-mount
#!/bin/bash
custom_mount_handler() {
    msg ":: mounting '\$root' on real root"
    if ! mount \${rootfstype:+-t \$rootfstype} -o \${rwopt:-ro}\${rootflags:+,\$rootflags} "\$root" "\$1"; then
        echo "You are now being dropped into an emergency shell."
        launch_interactive_shell
        msg "Trying to continue (this will most likely fail) ..."
    fi
}

run_earlyhook() {
    mount_handler=custom_mount_handler
}
EOF

cat <<EOF > $root/usr/lib/initcpio/install/fix-mount
#!/bin/bash
build() {
    add_runscript
}

help() {
    cat <<HELPEOF
This hook fixes booting to 9p filesystems
HELPEOF
}
EOF

cp mkinitcpio.conf $root/etc/

run_root mkinitcpio -p linux
run_root systemctl enable dhcpcd

run_root groupadd sudo
run_root useradd -mG sudo build
run_root passwd -d build
echo '%sudo ALL=(ALL) NOPASSWD: ALL' >> $root/etc/sudoers

sed -i 's/#PermitEmptyPasswords no/PermitEmptyPasswords yes/' $root/etc/ssh/sshd_config
run_root systemctl enable sshd

run_normal curl -O https://aur.archlinux.org/cgit/aur.git/snapshot/cower.tar.gz
run_normal tar xf cower.tar.gz
run_normal 'cd cower && makepkg -si --noconfirm --skippgpcheck'
run_normal rm -r cower cower.tar.gz

run_normal curl -O https://aur.archlinux.org/cgit/aur.git/snapshot/pacaur.tar.gz
run_normal tar xf pacaur.tar.gz
run_normal 'cd pacaur && makepkg -si --noconfirm --skippgpcheck'
run_normal rm -r pacaur pacaur.tar.gz

pkill gpg-agent
umount -R $root
mv $root root
